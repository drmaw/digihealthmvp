<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>Add Staff â€” DigiHealth</title>
</head>
<body>

<h2>Add Staff to Organization</h2>

<p id="status"></p>

<label>Email OR DigiHealth ID</label><br>
<input id="searchInput" placeholder="email@example.com or 10-digit ID">
<button id="searchBtn">Search</button>

<hr>

<div id="resultBox" style="display:none;">
  <p><b>Name:</b> <span id="name"></span></p>
  <p><b>Email:</b> <span id="email"></span></p>
  <p><b>Current Role:</b> <span id="role"></span></p>

  <label>Assign Role</label><br>
  <select id="roleSelect">
    <option value="">Select role</option>
    <option value="assistant_manager">Assistant Manager</option>
    <option value="staff">Staff</option>
    <option value="representative">Representative</option>
  </select><br><br>

  <button id="assignBtn">Assign to Organization</button>
</div>

<hr>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db } from "/js/firebase.js";
  import {
    collection,
    query,
    where,
    getDocs,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  let currentUser = null;
  let targetUser = null;

  // ðŸ” Only managers
  requireAuth(
    ["clinic_manager", "assistant_manager"],
    (profile) => {
      currentUser = profile;
    }
  );

  document.getElementById("searchBtn").onclick = async () => {
    const input = document.getElementById("searchInput").value.trim();
    const statusEl = document.getElementById("status");
    statusEl.innerText = "Searching...";
    targetUser = null;
    document.getElementById("resultBox").style.display = "none";

    if (!input) {
      statusEl.innerText = "Enter email or ID";
      return;
    }

    try {
      const usersRef = collection(db, "users");

      const q = isNaN(input)
        ? query(usersRef, where("email", "==", input))
        : query(usersRef, where("health_id_10", "==", input));

      const snap = await getDocs(q);

      if (snap.empty) {
        statusEl.innerText = "User not found";
        return;
      }

      const d = snap.docs[0];
      const user = { uid: d.id, ...d.data() };

      // âŒ Blocks
      if (user.role_id === "admin") {
        statusEl.innerText = "Admin cannot be assigned";
        return;
      }

      if (user.organization_id) {
        statusEl.innerText = "User already belongs to an organization";
        return;
      }

      if (user.status !== "active") {
        statusEl.innerText = "User is inactive";
        return;
      }

      // âœ… Show user
      targetUser = user;
      document.getElementById("name").innerText = user.name || "-";
      document.getElementById("email").innerText = user.email || "-";
      document.getElementById("role").innerText = user.role_id;

      document.getElementById("resultBox").style.display = "block";
      statusEl.innerText = "User found";

    } catch (e) {
      console.error(e);
      statusEl.innerText = "Error occurred";
    }
  };

  document.getElementById("assignBtn").onclick = async () => {
    const role = document.getElementById("roleSelect").value;
    const statusEl = document.getElementById("status");

    if (!targetUser || !role) {
      statusEl.innerText = "Select role first";
      return;
    }

    try {
      await updateDoc(doc(db, "users", targetUser.uid), {
        role_id: role,
        organization_id: currentUser.organization_id,
        approved: true,
        status: "active"
      });

      statusEl.innerText = "Staff assigned successfully";
      document.getElementById("resultBox").style.display = "none";

    } catch (e) {
      console.error(e);
      statusEl.innerText = "Assignment failed";
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
