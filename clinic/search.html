<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Patient Search â€” DigiHealth</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }

    .card {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 16px;
    }

    button {
      padding: 10px;
      font-size: 16px;
      margin-right: 5px;
      cursor: pointer;
    }

    #result {
      margin-top: 15px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>

<div class="card">
  <h3>ğŸ” Patient Search</h3>

  <input
    id="searchKey"
    placeholder="017XXXXXXXX or DigiHealth ID"
  />

  <button id="searchBtn">Search</button>
  <button onclick="openQR()">ğŸ“· Scan QR</button>

  <div id="result"></div>
</div>

<script type="module">
  import { requireRole } from "/js/auth_guard.js";
  import { searchUser } from "/js/search.js";

  let currentUser = null;

  // Clinic roles only
  requireRole(
    ["clinic_manager", "assistant_manager", "staff", "doctor"],
    (profile) => {
      currentUser = profile;
    }
  );

  const btn = document.getElementById("searchBtn");
  const input = document.getElementById("searchKey");
  const result = document.getElementById("result");

  btn.onclick = async () => {
    result.innerText = "";

    const key = input.value.trim();
    if (!key) {
      result.innerText = "âŒ Enter ID or phone number";
      return;
    }

    result.innerText = "Searching...";

    const user = await searchUser(key);

    if (!user) {
      result.innerText = "âŒ Patient not found";
      return;
    }

    result.innerHTML =
      `ğŸ‘¤ Name: ${user.name || "-"}\n` +
      `ğŸ†” DigiHealth ID: ${user.digihealth_id}\n` +
      `ğŸ“ Mobile: ${user.mobile || "-"}\n\n` +
      `<a href="/profile/view.html?uid=${user.uid}">
        âœ View Full Profile
      </a>`;
  };

  // QR open
  window.openQR = () => {
    location.href =
      "/qr/scan.html?return=" +
      encodeURIComponent(window.location.pathname);
  };
</script>

</body>
</html>
