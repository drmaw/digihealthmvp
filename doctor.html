<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>ডাক্তার ড্যাশবোর্ড</title>
</head>
<body>

<button id="logout">লগআউট</button>
<hr>

<h2>নতুন মেডিকেল রেকর্ড যোগ করুন</h2>

<label>রোগীর DigiHealth ID অথবা মোবাইল নম্বর</label><br>
<input id="searchInput" placeholder="DigiHealth ID বা মোবাইল নম্বর"><br><br>

<label>রোগ নির্ণয়</label><br>
<textarea id="diagnosis" rows="3"></textarea><br><br>

<label>প্রেসক্রিপশন / নোট</label><br>
<textarea id="notes" rows="5"></textarea><br><br>

<button id="saveRecord">সংরক্ষণ করুন</button>

<hr>
<pre id="status"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBqUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
  authDomain: "digihealth-65f04.firebaseapp.com",
  projectId: "digihealth-65f04",
  storageBucket: "digihealth-65f04.appspot.com",
  messagingSenderId: "704628949252",
  appId: "1:704628949252:web:b38a476bd9c4259f829051"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusBox = document.getElementById("status");

/* Auth + role protection */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "/index.html";
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));
  if (!snap.exists() || snap.data().role_id !== "doctor") {
    location.href = "/index.html";
    return;
  }
});

/* Logout */
document.getElementById("logout").onclick = async () => {
  await signOut(auth);
  location.href = "/index.html";
};

/* Save medical record */
document.getElementById("saveRecord").onclick = async () => {
  statusBox.textContent = "খোঁজা হচ্ছে...";

  const key = document.getElementById("searchInput").value.trim();
  const diagnosis = document.getElementById("diagnosis").value.trim();
  const notes = document.getElementById("notes").value.trim();

  if (!key || !diagnosis) {
    statusBox.textContent = "সব ঘর পূরণ করুন";
    return;
  }

  /* Search patient by DigiHealth ID or phone */
  let q = query(
    collection(db, "users"),
    where("health_id_10", "==", key)
  );

  let snap = await getDocs(q);

  if (snap.empty) {
    q = query(
      collection(db, "users"),
      where("phone", "==", key)
    );
    snap = await getDocs(q);
  }

  if (snap.empty) {
    statusBox.textContent = "রোগী পাওয়া যায়নি";
    return;
  }

  const patient = snap.docs[0];

  await addDoc(collection(db, "patient_records"), {
    patient_uid: patient.id,
    patient_health_id: patient.data().health_id_10,
    doctor_uid: auth.currentUser.uid,
    diagnosis,
    notes,
    createdAt: serverTimestamp()
  });

  statusBox.textContent = "মেডিকেল রেকর্ড সংরক্ষিত হয়েছে ✅";

  document.getElementById("diagnosis").value = "";
  document.getElementById("notes").value = "";
};
</script>

</body>
</html>
