<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>ডাক্তার</title>
</head>
<body>

<button id="logout">লগআউট</button>

<h3>DigiHealth QR</h3>
<img id="qr" alt="DigiHealth QR Code" />

<hr>

<input id="q" placeholder="ফোন / DigiHealth ID">
<button id="s">খুঁজুন</button>
<pre id="out"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { generateProfileQR } from "./js/qr.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBqUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
  authDomain: "digihealth-65f04.firebaseapp.com",
  projectId: "digihealth-65f04",
  storageBucket: "digihealth-65f04.appspot.com",
  messagingSenderId: "704628949252",
  appId: "1:704628949252:web:b38a476bd9c4259f829051"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Auth + role check */
onAuthStateChanged(auth, async (u) => {
  if (!u) {
    location.href = "/index.html";
    return;
  }

  const meSnap = await getDoc(doc(db, "users", u.uid));
  if (!meSnap.exists()) {
    location.href = "/index.html";
    return;
  }

  const me = meSnap.data();

  if (me.role_id !== "doctor") {
    location.href = "/index.html";
    return;
  }

  /* Generate QR for doctor */
  generateProfileQR(
    document.getElementById("qr"),
    {
      digihealth_id: me.digihealth_id,
      role: me.role_id
    }
  );
});

/* Logout */
logout.onclick = async () => {
  await signOut(auth);
  location.href = "/index.html";
};

/* Search patient by phone or DigiHealth ID */
s.onclick = async () => {
  out.textContent = "";

  let qRef;

  if (/^\d{10}$/.test(q.value)) {
    // DigiHealth ID
    qRef = query(
      collection(db, "users"),
      where("role_id", "==", "patient"),
      where("digihealth_id", "==", q.value)
    );
  } else {
    // Phone
    qRef = query(
      collection(db, "users"),
      where("role_id", "==", "patient"),
      where("mobile", "==", q.value)
    );
  }

  const snap = await getDocs(qRef);

  if (snap.empty) {
    out.textContent = "কোনো রোগী পাওয়া যায়নি";
    return;
  }

  snap.forEach(d =>
    out.textContent += JSON.stringify(d.data(), null, 2) + "\n"
  );
};
</script>

</body>
</html>
