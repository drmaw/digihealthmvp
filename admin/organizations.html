<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin â€” Organization Approvals</title>
</head>
<body>

<h2>Pending Organization Approvals</h2>
<p id="status">Loading...</p>

<table border="1" cellpadding="6">
  <thead>
    <tr>
      <th>Name</th>
      <th>License</th>
      <th>Owner UID</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="orgList"></tbody>
</table>

<hr>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db } from "/js/firebase.js";
  import {
    collection,
    query,
    where,
    getDocs,
    updateDoc,
    doc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const statusEl = document.getElementById("status");
  const listEl = document.getElementById("orgList");

  // ðŸ” Admin only
  requireAuth(["admin"], () => loadPending());

  async function loadPending() {
    statusEl.innerText = "Loading pending organizations...";
    listEl.innerHTML = "";

    const q = query(
      collection(db, "organizations"),
      where("status", "==", "pending")
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      statusEl.innerText = "No pending organizations.";
      return;
    }

    statusEl.innerText = "";

    snap.forEach(docSnap => {
      const org = docSnap.data();
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${org.name}</td>
        <td>
          <a href="${org.license_image_url}" target="_blank">View</a>
        </td>
        <td>${org.owner_uid}</td>
        <td>
          <button data-id="${docSnap.id}" data-owner="${org.owner_uid}" class="approve">
            Approve
          </button>
          <button data-id="${docSnap.id}" class="reject">
            Reject
          </button>
        </td>
      `;

      listEl.appendChild(tr);
    });

    bindActions();
  }

  function bindActions() {
    document.querySelectorAll(".approve").forEach(btn => {
      btn.onclick = async () => {
        const orgId = btn.dataset.id;
        const ownerUid = btn.dataset.owner;

        btn.disabled = true;
        btn.innerText = "Approving...";

        // 1ï¸âƒ£ Activate organization
        await updateDoc(doc(db, "organizations", orgId), {
          status: "active",
          approvedAt: serverTimestamp()
        });

        // 2ï¸âƒ£ Promote owner to clinic manager
        await updateDoc(doc(db, "users", ownerUid), {
          role_id: "clinic_manager",
          is_org_owner: true,
          organization_id: orgId,
          status: "active"
        });

        loadPending();
      };
    });

    document.querySelectorAll(".reject").forEach(btn => {
      btn.onclick = async () => {
        const orgId = btn.dataset.id;

        btn.disabled = true;
        btn.innerText = "Rejected";

        await updateDoc(doc(db, "organizations", orgId), {
          status: "rejected"
        });

        loadPending();
      };
    });
  }

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
