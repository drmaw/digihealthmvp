<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>DigiHealth â€” Admin Approvals</title>
</head>
<body>

<h2>Admin Approvals</h2>

<section>
  <h3>Pending Doctor Approvals</h3>
  <div id="doctorBox">Loading...</div>
</section>

<hr/>

<section>
  <h3>Pending Organization Approvals</h3>
  <div id="orgBox">Loading...</div>
</section>

<hr/>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db } from "/js/firebase.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    getDocs,
    query,
    where,
    doc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth(["admin"], async () => {
    loadDoctors();
    loadOrganizations();
  });

  async function loadDoctors() {
    const box = document.getElementById("doctorBox");
    box.innerHTML = "";

    const q = query(
      collection(db, "users"),
      where("role_id", "==", "doctor"),
      where("approved", "==", false)
    );

    const snap = await getDocs(q);
    if (snap.empty) {
      box.innerText = "No pending doctors";
      return;
    }

    snap.forEach(d => {
      const u = { uid: d.id, ...d.data() };
      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.margin = "8px";
      div.style.padding = "8px";

      div.innerHTML = `
        <p><b>Name:</b> ${u.name || "-"}</p>
        <p><b>BMDC:</b> ${u.bmdc || "-"}</p>
        <button>Approve</button>
      `;

      div.querySelector("button").onclick = async () => {
        await updateDoc(doc(db, "users", u.uid), { approved: true });
        loadDoctors();
      };

      box.appendChild(div);
    });
  }

  async function loadOrganizations() {
    const box = document.getElementById("orgBox");
    box.innerHTML = "";

    const q = query(
      collection(db, "organizations"),
      where("status", "==", "pending")
    );

    const snap = await getDocs(q);
    if (snap.empty) {
      box.innerText = "No pending organizations";
      return;
    }

    snap.forEach(d => {
      const o = { id: d.id, ...d.data() };
      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.margin = "8px";
      div.style.padding = "8px";

      div.innerHTML = `
        <p><b>Name:</b> ${o.name}</p>
        <p><b>Reg No:</b> ${o.registration_no || "-"}</p>
        <button>Approve</button>
      `;

      div.querySelector("button").onclick = async () => {
        await updateDoc(doc(db, "organizations", o.id), {
          status: "approved"
        });
        loadOrganizations();
      };

      box.appendChild(div);
    });
  }

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
