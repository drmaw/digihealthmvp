<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>DigiHealth â€” Create Appointment</title>
</head>
  <link rel="stylesheet" href="/css/app.css">
<body>

<h2>Create Appointment</h2>

<p id="status"></p>

<section>
  <input id="patientInput" placeholder="Patient DigiHealth ID / Mobile" />
</section>

<br/>

<section>
  <label>Doctor</label><br/>
  <select id="doctorSelect">
    <option value="">Select Doctor</option>
  </select>
</section>

<br/>

<section>
  <label>Date</label><br/>
  <input type="date" id="date" />
</section>

<br/>

<section>
  <label>Time</label><br/>
  <input type="time" id="time" />
</section>

<br/>
<button id="createBtn">Create Appointment</button>

<hr/>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db } from "/js/firebase.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    addDoc,
    getDocs,
    query,
    where,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let currentUser = null;

  requireAuth(
    ["patient", "clinic_manager", "assistant_manager"],
    async (profile) => {
      currentUser = profile;
      loadDoctors();
    }
  );

  async function loadDoctors() {
    if (!currentUser.organization_id) return;

    const q = query(
      collection(db, "organization_doctors"),
      where("organization_id", "==", currentUser.organization_id)
    );

    const snap = await getDocs(q);
    const select = document.getElementById("doctorSelect");

    snap.forEach(d => {
      const doc = d.data();
      const opt = document.createElement("option");
      opt.value = doc.doctor_uid;
      opt.textContent = doc.doctor_name || doc.doctor_uid;
      select.appendChild(opt);
    });
  }

  document.getElementById("createBtn").onclick = async () => {
    const statusEl = document.getElementById("status");
    statusEl.innerText = "Creating...";

    const input = document.getElementById("patientInput").value.trim();
    const doctorUid = document.getElementById("doctorSelect").value;
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;

    if (!input || !doctorUid || !date || !time) {
      statusEl.innerText = "All fields required";
      return;
    }

    try {
      // Find patient
      const usersRef = collection(db, "users");
      const q = isNaN(input)
        ? query(usersRef, where("phone", "==", input))
        : query(usersRef, where("health_id_10", "==", input));

      const snap = await getDocs(q);
      if (snap.empty) {
        statusEl.innerText = "Patient not found";
        return;
      }

      const patientUid = snap.docs[0].id;

      await addDoc(collection(db, "appointments"), {
        patient_uid: patientUid,
        doctor_uid: doctorUid,
        organization_id: currentUser.organization_id || null,
        appointment_date: date,
        appointment_time: time,
        status: "requested",
        created_by_uid: currentUser.uid,
        created_by_role: currentUser.role_id,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      statusEl.innerText = "Appointment created";

    } catch (e) {
      console.error(e);
      statusEl.innerText = "Error occurred";
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
