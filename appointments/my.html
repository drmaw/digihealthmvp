<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>DigiHealth â€” My Appointments</title>
</head>
<body>

<h2>My Appointments</h2>

<p id="status">Loading...</p>
<section id="appointments"></section>

<hr />
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db } from "/js/firebase.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let currentUser = null;

  requireAuth(
    ["patient", "doctor", "clinic_manager", "assistant_manager"],
    async (profile) => {
      currentUser = profile;
      loadAppointments();
    }
  );

  async function loadAppointments() {
    const statusEl = document.getElementById("status");
    statusEl.innerText = "Loading...";

    let q;

    if (currentUser.role_id === "patient") {
      q = query(
        collection(db, "appointments"),
        where("patient_uid", "==", currentUser.uid)
      );
    } else if (currentUser.role_id === "doctor") {
      q = query(
        collection(db, "appointments"),
        where("doctor_uid", "==", currentUser.uid)
      );
    } else {
      q = query(
        collection(db, "appointments"),
        where("organization_id", "==", currentUser.organization_id)
      );
    }

    const snap = await getDocs(q);
    const box = document.getElementById("appointments");
    box.innerHTML = "";

    if (snap.empty) {
      statusEl.innerText = "No appointments";
      return;
    }

    snap.forEach(docSnap => {
      const a = { id: docSnap.id, ...docSnap.data() };
      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.margin = "10px";
      div.style.padding = "10px";

      div.innerHTML = `
        <p><b>Date:</b> ${a.appointment_date}</p>
        <p><b>Time:</b> ${a.appointment_time}</p>
        <p><b>Status:</b> ${a.status}</p>
      `;

      // Doctor actions
      if (currentUser.role_id === "doctor") {
        const doneBtn = document.createElement("button");
        doneBtn.textContent = "Mark Completed";
        doneBtn.onclick = async () => {
          await updateDoc(doc(db, "appointments", a.id), {
            status: "completed"
          });
          loadAppointments();
        };

        const cancelBtn = document.createElement("button");
        cancelBtn.textContent = "Cancel";
        cancelBtn.onclick = async () => {
          await updateDoc(doc(db, "appointments", a.id), {
            status: "cancelled"
          });
          loadAppointments();
        };

        div.appendChild(doneBtn);
        div.appendChild(cancelBtn);
      }

      // Manager / Assistant delete
      if (
        currentUser.role_id === "clinic_manager" ||
        currentUser.role_id === "assistant_manager"
      ) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.style.color = "red";
        delBtn.onclick = async () => {
          if (!confirm("Delete appointment?")) return;
          await deleteDoc(doc(db, "appointments", a.id));
          loadAppointments();
        };
        div.appendChild(delBtn);
      }

      box.appendChild(div);
    });

    statusEl.innerText = "Loaded";
  }

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
