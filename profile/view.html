<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>DigiHealth â€” My Profile</title>
</head>
<body>

<h2>My Profile</h2>

<p id="status">Loading...</p>

<form id="profileForm" style="display:none;">
  <label>Name</label><br/>
  <input id="name"/><br/><br/>

  <label>Gender</label><br/>
  <select id="gender">
    <option value="">--</option>
    <option value="male">Male</option>
    <option value="female">Female</option>
    <option value="other">Other</option>
  </select><br/><br/>

  <label>Age</label><br/>
  <input id="age" type="number"/><br/><br/>

  <label>Occupation</label><br/>
  <input id="occupation"/><br/><br/>

  <label>Address</label><br/>
  <textarea id="address"></textarea><br/><br/>

  <button type="button" id="saveBtn">Save</button>
</form>

<hr/>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db } from "/js/firebase.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, getDoc, updateDoc } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getProfilePermissions } from
    "/js/profile_field_access.js";

  let currentUser = null;

  requireAuth(
    ["patient", "doctor", "clinic_manager", "assistant_manager", "admin"],
    async (profile) => {
      currentUser = profile;
      loadProfile();
    }
  );

  async function loadProfile() {
    const statusEl = document.getElementById("status");
    const form = document.getElementById("profileForm");

    const snap = await getDoc(doc(db, "users", currentUser.uid));
    const data = snap.data();

    const perms = getProfilePermissions(currentUser, currentUser.uid);
    if (!perms) {
      statusEl.innerText = "Access denied";
      return;
    }

    // Populate fields
    name.value = data.name || "";
    gender.value = data.gender || "";
    age.value = data.age || "";
    occupation.value = data.occupation || "";
    address.value = data.address || "";

    // Disable fields not editable
    ["name","gender","age","occupation","address"].forEach(f => {
      if (perms.edit !== "all" && !perms.edit.includes(f)) {
        document.getElementById(f).disabled = true;
      }
    });

    form.style.display = "block";
    statusEl.innerText = "Loaded";
  }

  document.getElementById("saveBtn").onclick = async () => {
    const updates = {
      name: name.value,
      gender: gender.value,
      age: Number(age.value),
      occupation: occupation.value,
      address: address.value
    };

    await updateDoc(doc(db, "users", currentUser.uid), updates);
    document.getElementById("status").innerText = "Saved";
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
