<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>DigiHealth â€“ Profile</title>
</head>
<body>

<h2>Profile</h2>
<p id="status">Loading...</p>

<form id="profileForm" style="display:none">
  <label>Name</label><br>
  <input id="name"><br><br>

  <label>Gender</label><br>
  <input id="gender"><br><br>

  <label>Age</label><br>
  <input id="age" type="number"><br><br>

  <label>Occupation</label><br>
  <input id="occupation"><br><br>

  <label>Address</label><br>
  <textarea id="address"></textarea><br><br>

  <button type="button" id="saveBtn">Save</button>
</form>

<hr>
<button id="logoutBtn">Logout</button>

<script type="module">
import { requireAuth } from "/js/auth_guard.js";
import { db } from "/js/firebase.js";
import { doc, getDoc, updateDoc } from
  "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
import { signOut } from
  "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import {
  canViewProfile,
  canEditProfile
} from "/js/access_control.js";

const params = new URLSearchParams(location.search);
const targetUid = params.get("uid");

const statusEl = document.getElementById("status");
const form = document.getElementById("profileForm");

const fields = ["name","gender","age","occupation","address"];
const inputs = Object.fromEntries(fields.map(f => [f, document.getElementById(f)]));

const currentUser = await requireAuth();
const targetSnap = await getDoc(doc(db, "users", targetUid || currentUser.uid));
const targetUser = { uid: targetSnap.id, ...targetSnap.data() };

if (!canViewProfile(currentUser, targetUser)) {
  statusEl.innerText = "Access denied";
  throw new Error("Denied");
}

fields.forEach(f => inputs[f].value = targetUser[f] || "");

if (!canEditProfile(currentUser, targetUser)) {
  fields.forEach(f => inputs[f].disabled = true);
  document.getElementById("saveBtn").style.display = "none";
}

form.style.display = "block";
statusEl.innerText = "Loaded";

document.getElementById("saveBtn").onclick = async () => {
  const data = {};
  fields.forEach(f => data[f] = inputs[f].value);
  await updateDoc(doc(db, "users", targetUser.uid), data);
  alert("Saved");
};

document.getElementById("logoutBtn").onclick = async () => {
  await signOut((await import("/js/firebase.js")).auth);
  location.href = "/index.html";
};
</script>

</body>
</html>
