<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Dashboard</title>
</head>

<body>
  <h2>Patient Dashboard</h2>

  <p><strong>My DigiHealth ID:</strong></p>
  <p id="healthId">Loading...</p>

  <h3>My QR Code</h3>
  <img id="qrImg" width="180" height="180" />

  <br><br>
  <button id="logoutBtn">Logout</button>

  <script type="module">
    import { auth, db } from "/js/firebase.js";
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import { doc, getDoc, updateDoc } from "firebase/firestore";
    import { generateProfileQR } from "/js/qr.js";

    const healthIdEl = document.getElementById("healthId");
    const qrImg = document.getElementById("qrImg");

    function generateHealthId10(uid) {
      let hash = 0;
      for (let i = 0; i < uid.length; i++) {
        hash = (hash << 5) - hash + uid.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash).toString().padStart(10, "0").slice(0, 10);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/index.html";
        return;
      }

      try {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          healthIdEl.innerText = "Profile not found";
          return;
        }

        let data = snap.data();
        let healthId = data.health_id_10;

        // ðŸ”¥ AUTO-CREATE IF MISSING
        if (!healthId) {
          healthId = generateHealthId10(user.uid);
          await updateDoc(ref, { health_id_10: healthId });
        }

        healthIdEl.innerText = healthId;

        // âœ… GENERATE QR
        generateProfileQR(qrImg, {
          health_id_10: healthId
        });

      } catch (err) {
        console.error(err);
        healthIdEl.innerText = "Error loading profile";
      }
    });

    document.getElementById("logoutBtn").onclick = async () => {
      await signOut(auth);
      window.location.href = "/index.html";
    };
  </script>
</body>
</html>
