<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Dashboard</title>
</head>
<body>

<h2>Patient Dashboard</h2>

<p><strong>My DigiHealth ID:</strong></p>
<p id="healthId">Loading...</p>

<h3>My QR Code</h3>
<img id="qrImg" width="180" height="180" />

<br><br>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { auth, db } from "/js/firebase.js";
  import { onAuthStateChanged, signOut } from "firebase/auth";
  import { doc, getDoc } from "firebase/firestore";
  import { generateProfileQR } from "/js/qr.js";

  const healthIdEl = document.getElementById("healthId");
  const qrImg = document.getElementById("qrImg");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/index.html";
      return;
    }

    try {
      const snap = await getDoc(doc(db, "users", user.uid));

      if (!snap.exists()) {
        healthIdEl.innerText = "Profile not found";
        return;
      }

      const data = snap.data();

      // ðŸ”´ REQUIRED FIELD
      if (!data.health_id_10) {
        healthIdEl.innerText = "health_id_10 missing";
        return;
      }

      healthIdEl.innerText = data.health_id_10;

      // âœ… GENERATE QR
      generateProfileQR(qrImg, {
        health_id_10: data.health_id_10
      });

    } catch (err) {
      console.error(err);
      healthIdEl.innerText = "Error loading profile";
    }
  });

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    window.location.href = "/index.html";
  };
</script>

</body>
</html>
