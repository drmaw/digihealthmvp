<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>রোগী</title>
</head>
<body>

<button id="logout">লগআউট</button>

<h3>DigiHealth QR</h3>
<img id="qr" alt="DigiHealth QR Code" />

<h3>আমার তথ্য</h3>
<pre id="me"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { generateProfileQR } from "./js/qr.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBqUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
  authDomain: "digihealth-65f04.firebaseapp.com",
  projectId: "digihealth-65f04",
  storageBucket: "digihealth-65f04.appspot.com",
  messagingSenderId: "704628949252",
  appId: "1:704628949252:web:b38a476bd9c4259f829051"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, async (u) => {
  if (!u) {
    location.href = "/index.html";
    return;
  }

  const snap = await getDoc(doc(db, "users", u.uid));

  if (!snap.exists()) {
    location.href = "/index.html";
    return;
  }

  const data = snap.data();

  // role protection
  if (data.role_id !== "patient") {
    location.href = "/index.html";
    return;
  }

  // show profile
  me.textContent = JSON.stringify(data, null, 2);

  // generate QR using DigiHealth ID
  generateProfileQR(
    document.getElementById("qr"),
    {
      digihealth_id: data.digihealth_id,
      role: data.role_id
    }
  );
});

logout.onclick = async () => {
  await signOut(auth);
  location.href = "/index.html";
};
</script>

</body>
</html>
