<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Dashboard</title>

  <!-- QR generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Firebase -->
  <script type="module" src="/firebase.js"></script>
  <script type="module" src="/js/auth_guard.js"></script>

  <style>
    #qr-box {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      display: inline-block;
    }
  </style>
</head>

<body>
  <h2>Patient Dashboard</h2>

  <p><strong>My DigiHealth ID:</strong></p>
  <p id="healthId">Loading...</p>

  <h3>My QR Code</h3>
  <div id="qr-box"></div>

  <br /><br />
  <button onclick="logout()">Logout</button>

  <script type="module">
    import { auth, db } from "/firebase.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    auth.onAuthStateChanged(async (user) => {
      if (!user) return;

      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists()) return;

      const data = snap.data();

      const healthId = data.health_id_10;
      document.getElementById("healthId").innerText = healthId;

      // Generate QR
      new QRCode(document.getElementById("qr-box"), {
        text: healthId,
        width: 220,
        height: 220
      });
    });

    window.logout = async () => {
      await signOut(auth);
      window.location.href = "/index.html";
    };
  </script>
</body>
</html>
