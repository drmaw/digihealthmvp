<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Patient Dashboard</title>
</head>
<body>

<h2>Patient Dashboard</h2>

<p>
  <strong>My DigiHealth ID:</strong>
  <span id="healthId">Loading...</span>
</p>

<h3>My QR Code</h3>
<img id="qrImage" width="180" height="180" alt="QR Code will appear here" />

<br><br>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { auth, db } from "/js/firebase.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { generateProfileQR } from "/js/qr.js";

  const healthIdEl = document.getElementById("healthId");
  const qrImg = document.getElementById("qrImage");
  const logoutBtn = document.getElementById("logoutBtn");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "/index.html";
      return;
    }

    try {
      const snap = await getDoc(doc(db, "users", user.uid));

      if (!snap.exists()) {
        healthIdEl.textContent = "Profile not found";
        return;
      }

      const data = snap.data();

      if (!data.health_id_10) {
        healthIdEl.textContent = "Health ID missing";
        return;
      }

      // 1️⃣ Show ID
      healthIdEl.textContent = data.health_id_10;

      // 2️⃣ Generate QR
      generateProfileQR(qrImg, {
        health_id_10: data.health_id_10
      });

    } catch (err) {
      console.error(err);
      healthIdEl.textContent = "Error loading profile";
    }
  });

  logoutBtn.onclick = async () => {
    await signOut(auth);
    window.location.href = "/index.html";
  };
</script>

</body>
</html>
