<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Patient Dashboard</title>
</head>
<body>

<h1>Patient Dashboard</h1>

<p><b>My DigiHealth ID:</b></p>
<p id="healthId">Loading...</p>

<h3>My QR Code</h3>
<div id="qr"></div>

<hr>
<button id="logoutBtn">Logout</button>

<!-- QR library -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const healthIdEl = document.getElementById("healthId");
  const qrEl = document.getElementById("qr");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "/index.html";
      return;
    }

    try {
      const snap = await getDoc(doc(db, "users", user.uid));

      if (!snap.exists()) {
        healthIdEl.innerText = "Profile missing";
        return;
      }

      const data = snap.data();
      const digiId = data.health_id_10;

      if (!digiId) {
        healthIdEl.innerText = "DigiHealth ID not assigned";
        return;
      }

      healthIdEl.innerText = digiId;

      qrEl.innerHTML = "";
      new QRCode(qrEl, {
        text: digiId,
        width: 180,
        height: 180
      });

    } catch (e) {
      console.error(e);
      healthIdEl.innerText = "Error loading profile";
    }
  });

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
