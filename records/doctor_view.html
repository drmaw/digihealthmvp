<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Doctor – Patient Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<h3>রোগীর মেডিকেল রেকর্ড</h3>

<input
  id="patientInput"
  placeholder="Patient DigiHealth ID / Mobile"
  style="width:100%;padding:8px;"
>
<br><br>
<button id="findBtn">খুঁজুন</button>

<p id="status"></p>
<hr>

<div id="records"></div>

<script type="module">
/* ---------------- Firebase imports ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------------- Firebase config ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBQUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
  authDomain: "digihealth-65f04.firebaseapp.com",
  projectId: "digihealth-65f04"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ---------------- DOM refs ---------------- */
const statusBox = document.getElementById("status");
const recordsBox = document.getElementById("records");
const findBtn = document.getElementById("findBtn");

/* ---------------- Auth guard ---------------- */
onAuthStateChanged(auth, (user) => {
  if (!user) {
    location.href = "/index.html";
    return;
  }

  findBtn.onclick = () => loadPatientRecords();
});

/* ---------------- Main logic ---------------- */
async function loadPatientRecords() {
  recordsBox.innerHTML = "";
  statusBox.innerText = "খোঁজা হচ্ছে...";

  const input = document.getElementById("patientInput").value.trim();
  if (!input) {
    statusBox.innerText = "আইডি বা মোবাইল নম্বর দিন";
    return;
  }

  try {
    /* 1️⃣ Find patient */
    const usersRef = collection(db, "users");

    const userQuery = isNaN(input)
      ? query(usersRef, where("phone", "==", input))
      : query(usersRef, where("health_id_10", "==", input));

    const userSnap = await getDocs(userQuery);

    if (userSnap.empty) {
      statusBox.innerText = "রোগী পাওয়া যায়নি";
      return;
    }

    const patientUid = userSnap.docs[0].id;

    /* 2️⃣ Load records (EXCLUDING patient_only) */
    const recordsRef = collection(db, "patient_records");

    const recordsQuery = query(
      recordsRef,
      where("patient_uid", "==", patientUid),
      where("visibility", "!=", "patient_only")
    );

    const recordSnap = await getDocs(recordsQuery);

    if (recordSnap.empty) {
      statusBox.innerText = "এই রোগীর কোনো দৃশ্যমান রেকর্ড নেই";
      return;
    }

    statusBox.innerText = "রেকর্ড পাওয়া গেছে";

    recordSnap.forEach(doc => {
      const r = doc.data();

      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.padding = "10px";
      div.style.marginBottom = "10px";

      div.innerHTML = `
        <b>ধরন:</b> ${r.record_type || "-"}<br>
        <b>শিরোনাম:</b> ${r.title || "-"}<br>
        <b>নোট:</b> ${r.notes || "-"}<br>
        <b>দৃশ্যমানতা:</b> ${r.visibility}<br>
        <small>
          তৈরি: ${r.created_at?.toDate ? r.created_at.toDate().toLocaleString() : ""}
        </small>
      `;

      recordsBox.appendChild(div);
    });

  } catch (err) {
    console.error(err);
    statusBox.innerText = "সমস্যা হয়েছে, আবার চেষ্টা করুন";
  }
}
</script>

</body>
</html>
