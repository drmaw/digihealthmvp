<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Doctor – Patient Records</title>
</head>
<body>

<h2>রোগীর মেডিকেল রেকর্ড দেখুন</h2>

<input id="patientInput" placeholder="Patient DigiHealth ID / Mobile">
<button id="searchBtn">খুঁজুন</button>

<p id="status"></p>
<hr>

<div id="records"></div>

<script type="module">
  import { db } from "../js/firebase.js";
  import { requireRole } from "../js/auth.js";

  import {
    collection,
    query,
    where,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const status = document.getElementById("status");
  const recordsBox = document.getElementById("records");

  requireRole(["doctor"], (doctor) => {

    document.getElementById("searchBtn").onclick = async () => {
      recordsBox.innerHTML = "";
      status.innerText = "খোঁজা হচ্ছে...";

      const input = patientInput.value.trim();
      if (!input) {
        status.innerText = "আইডি বা নম্বর দিন";
        return;
      }

      try {
        /* 1. Find patient */
        const usersRef = collection(db, "users");
        const q = isNaN(input)
          ? query(usersRef, where("phone", "==", input))
          : query(usersRef, where("health_id_10", "==", input));

        const snap = await getDocs(q);
        if (snap.empty) {
          status.innerText = "রোগী পাওয়া যায়নি";
          return;
        }

        const patientUid = snap.docs[0].id;

        /* 2. Load records (exclude private) */
        const recordsRef = collection(db, "patient_records");
        const rq = query(
          recordsRef,
          where("patient_uid", "==", patientUid),
          where("visibility", "!=", "private")
        );

        const rsnap = await getDocs(rq);

        if (rsnap.empty) {
          status.innerText = "কোনো রেকর্ড নেই";
          return;
        }

        status.innerText = "রেকর্ড পাওয়া গেছে";

        rsnap.forEach(doc => {
          const r = doc.data();
          const div = document.createElement("div");

          div.style.border = "1px solid #ccc";
          div.style.padding = "10px";
          div.style.margin = "10px 0";

          div.innerHTML = `
            <b>টাইপ:</b> ${r.record_type}<br>
            <b>শিরোনাম:</b> ${r.title || ""}<br>
            <b>নোট:</b><br>${r.notes || ""}<br>
            <small>
              ${r.created_at?.toDate ? r.created_at.toDate() : ""}
            </small>
          `;

          recordsBox.appendChild(div);
        });

      } catch (e) {
        console.error(e);
        status.innerText = "সমস্যা হয়েছে";
      }
    };

  });
</script>

</body>
</html>
