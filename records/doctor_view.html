<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>Doctor – Patient Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>

<button onclick="logout()">লগআউট</button>

<h2>ডাক্তারের মেডিকেল রেকর্ড</h2>

<p id="status">লোড হচ্ছে...</p>

<hr>

<div id="records"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- Firebase Config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBQUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
  authDomain: "digihealth-65f04.firebaseapp.com",
  projectId: "digihealth-65f04"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusBox = document.getElementById("status");
const recordsDiv = document.getElementById("records");

/* ---------- Logout ---------- */
window.logout = async () => {
  await signOut(auth);
  location.href = "/index.html";
};

/* ---------- Auth Guard ---------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    statusBox.innerText = "লগইন করা নেই";
    return;
  }

  statusBox.innerText = "রেকর্ড লোড হচ্ছে...";

  try {
    /* ---------- Fetch Doctor Records ---------- */
    const q = query(
      collection(db, "patient_records"),
      where("created_by_uid", "==", user.uid),
      orderBy("created_at", "desc")
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      statusBox.innerText = "কোনো রেকর্ড পাওয়া যায়নি";
      return;
    }

    statusBox.innerText = `মোট রেকর্ড: ${snap.size}`;

    snap.forEach(doc => {
      const r = doc.data();

      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.margin = "10px 0";
      div.style.padding = "10px";

      div.innerHTML = `
        <b>রোগীর UID:</b> ${r.patient_uid}<br>
        <b>টাইপ:</b> ${r.record_type}<br>
        <b>শিরোনাম:</b> ${r.title}<br>
        <b>নোট:</b> ${r.notes}<br>
        <b>Visibility:</b> ${r.visibility}<br>
        <b>সংস্থা:</b> ${r.organization_id || "N/A"}<br>
        <small>তারিখ: ${r.created_at?.toDate?.().toLocaleString("bn-BD") || ""}</small>
      `;

      recordsDiv.appendChild(div);
    });

  } catch (e) {
    console.error(e);
    statusBox.innerText = "সমস্যা হয়েছে, আবার চেষ্টা করুন";
  }
});
</script>

</body>
</html>
