<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Doctor – Patient Records</title>
</head>
<body>

<h3>রোগীর রেকর্ড দেখুন</h3>

<input id="patientInput" placeholder="Patient DigiHealth ID / Mobile">
<button id="findBtn">খুঁজুন</button>

<p id="status"></p>
<hr>
<div id="records"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBQUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
  authDomain: "digihealth-65f04.firebaseapp.com",
  projectId: "digihealth-65f04"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const statusBox = document.getElementById("status");
const recordsBox = document.getElementById("records");

onAuthStateChanged(auth, user => {
  if (!user) {
    location.href = "/index.html";
    return;
  }

  document.getElementById("findBtn").onclick = async () => {
    recordsBox.innerHTML = "";
    statusBox.innerText = "খোঁজা হচ্ছে...";

    const input = document.getElementById("patientInput").value.trim();
    if (!input) {
      statusBox.innerText = "আইডি দিন";
      return;
    }

    try {
      const usersRef = collection(db, "users");
      const uq = isNaN(input)
        ? query(usersRef, where("phone", "==", input))
        : query(usersRef, where("health_id_10", "==", input));

      const usnap = await getDocs(uq);
      if (usnap.empty) {
        statusBox.innerText = "রোগী পাওয়া যায়নি";
        return;
      }

      const patientUid = usnap.docs[0].id;

      const rq = query(
        collection(db, "patient_records"),
        where("patient_uid", "==", patientUid),
        where("visibility", "!=", "patient_only")
      );

      const rsnap = await getDocs(rq);
      if (rsnap.empty) {
        statusBox.innerText = "দেখার মতো কোনো রেকর্ড নেই";
        return;
      }

      statusBox.innerText = "রেকর্ড পাওয়া গেছে";

      rsnap.forEach(d => {
        const r = d.data();
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.padding = "8px";
        div.style.margin = "8px 0";
        div.innerHTML = `
          <b>${r.record_type}</b><br>
          ${r.notes || ""}<br>
        `;
        recordsBox.appendChild(div);
      });

    } catch (e) {
      console.error(e);
      statusBox.innerText = "সমস্যা হয়েছে";
    }
  };
});
</script>

</body>
</html>
