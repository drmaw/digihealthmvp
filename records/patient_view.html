<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>DigiHealth â€” My Medical Records</title>
</head>
<body>

<h2>My Medical Records</h2>

<p id="status">Loading...</p>

<section id="records"></section>

<hr />
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db } from "/js/firebase.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    getDocs,
    query,
    where,
    doc,
    updateDoc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let currentUser = null;

  // ðŸ” Guard: Patient only (self)
  requireAuth(["patient"], async (profile) => {
    currentUser = profile;
    loadRecords();
  });

  async function loadRecords() {
    const statusEl = document.getElementById("status");
    statusEl.innerText = "Loading records...";

    const q = query(
      collection(db, "patient_records"),
      where("patient_uid", "==", currentUser.uid)
    );

    const snap = await getDocs(q);
    const box = document.getElementById("records");
    box.innerHTML = "";

    if (snap.empty) {
      statusEl.innerText = "No records found";
      return;
    }

    snap.forEach(docSnap => {
      const r = { id: docSnap.id, ...docSnap.data() };
      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.margin = "10px";
      div.style.padding = "10px";

      div.innerHTML = `
        <b>${r.record_type}</b><br/>
        <b>${r.title || ""}</b><br/>
        ${r.notes || ""}<br/>
        <small>Visibility: ${r.visibility}</small><br/><br/>
        <button class="toggleBtn">Toggle Visibility</button>
        <button class="deleteBtn" style="color:red;">Delete</button>
      `;

      // Toggle visibility
      div.querySelector(".toggleBtn").onclick = async () => {
        const newVis = r.visibility === "public" ? "private" : "public";
        await updateDoc(doc(db, "patient_records", r.id), {
          visibility: newVis
        });
        loadRecords();
      };

      // Delete record
      div.querySelector(".deleteBtn").onclick = async () => {
        if (!confirm("Are you sure you want to permanently delete this record?")) {
          return;
        }
        await deleteDoc(doc(db, "patient_records", r.id));
        loadRecords();
      };

      box.appendChild(div);
    });

    statusEl.innerText = "Loaded";
  }

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
