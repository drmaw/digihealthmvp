<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Patient – My Medical Records</title>
</head>
<body>

<h2>আমার মেডিকেল রেকর্ড</h2>

<p id="status">লোড হচ্ছে...</p>
<hr>

<div id="records"></div>

<script type="module">
  import { db } from "../js/firebase.js";
  import { requireRole } from "../js/auth.js";

  import {
    collection,
    query,
    where,
    getDocs,
    doc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const status = document.getElementById("status");
  const recordsBox = document.getElementById("records");

  requireRole(["patient"], async (patient) => {
    try {
      const recordsRef = collection(db, "patient_records");
      const q = query(recordsRef, where("patient_uid", "==", patient.uid));
      const snap = await getDocs(q);

      if (snap.empty) {
        status.innerText = "কোনো রেকর্ড নেই";
        return;
      }

      status.innerText = "";

      snap.forEach(d => {
        const r = d.data();
        const div = document.createElement("div");

        div.style.border = "1px solid #ccc";
        div.style.padding = "10px";
        div.style.margin = "10px 0";

        const visibility = r.visibility || "public";

        div.innerHTML = `
          <b>টাইপ:</b> ${r.record_type}<br>
          <b>শিরোনাম:</b> ${r.title || ""}<br>
          <b>নোট:</b><br>${r.notes || ""}<br>
          <b>দৃশ্যমানতা:</b>
          <select data-id="${d.id}">
            <option value="public" ${visibility==="public"?"selected":""}>Public</option>
            <option value="private" ${visibility==="private"?"selected":""}>Private</option>
          </select>
          <br>
          <small>
            ${r.created_at?.toDate ? r.created_at.toDate() : ""}
          </small>
        `;

        recordsBox.appendChild(div);
      });

      /* Handle visibility change */
      recordsBox.querySelectorAll("select").forEach(sel => {
        sel.onchange = async () => {
          const id = sel.getAttribute("data-id");
          await updateDoc(doc(db, "patient_records", id), {
            visibility: sel.value
          });
        };
      });

    } catch (e) {
      console.error(e);
      status.innerText = "লোড করতে সমস্যা হয়েছে";
    }
  });
</script>

</body>
</html>
