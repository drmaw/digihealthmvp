<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Add Medical Record</title>
</head>
<body>

<h2>নতুন মেডিকেল রেকর্ড যোগ করুন</h2>

<input id="patientInput" placeholder="Patient DigiHealth ID / Mobile">
<br><br>

<input id="title" placeholder="রোগ নির্ণয় / শিরোনাম">
<br><br>

<textarea id="notes" placeholder="প্রেসক্রিপশন / নোট"></textarea>
<br><br>

<button id="saveBtn">সংরক্ষণ করুন</button>
<p id="status"></p>

<script type="module">
import { db } from "../js/firebase.js";
import { requireRole } from "../js/auth.js";
import {
  collection,
  addDoc,
  serverTimestamp,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const status = document.getElementById("status");

requireRole(["doctor"], async (doctor) => {
  document.getElementById("saveBtn").onclick = async () => {
    status.innerText = "সংরক্ষণ হচ্ছে...";

    const input = patientInput.value.trim();
    const titleVal = title.value.trim();
    const notesVal = notes.value.trim();

    if (!input || !titleVal) {
      status.innerText = "সব তথ্য দিন";
      return;
    }

    try {
      // Find patient
      const usersRef = collection(db, "users");
      const q = isNaN(input)
        ? query(usersRef, where("phone", "==", input))
        : query(usersRef, where("health_id_10", "==", input));

      const snap = await getDocs(q);
      if (snap.empty) {
        status.innerText = "রোগী পাওয়া যায়নি";
        return;
      }

      const patientUid = snap.docs[0].id;

      // Create record
      await addDoc(collection(db, "patient_records"), {
        patient_uid: patientUid,
        created_by_uid: doctor.uid,
        created_by_role: "doctor",
        record_type: "general",
        title: titleVal,
        notes: notesVal,
        visibility: "public",   // default
        created_at: serverTimestamp(),
        updated_at: serverTimestamp()
      });

      status.innerText = "রেকর্ড সংরক্ষিত হয়েছে";
      title.value = "";
      notes.value = "";

    } catch (e) {
      console.error(e);
      status.innerText = "সমস্যা হয়েছে";
    }
  };
});
</script>

</body>
</html>
