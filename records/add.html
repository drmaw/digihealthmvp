<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>DigiHealth â€” Add Medical Record</title>
</head>
<body>

<h2>Add Medical Record / Upload Document</h2>

<section>
  <input id="patientInput" placeholder="DigiHealth ID / Mobile" />
  <button id="scanBtn">Scan QR</button>
  <div id="qrBox"></div>
</section>

<hr />

<section id="doctorFields" style="display:none;">
  <h3>Doctor Entry</h3>
  <select id="recordType">
    <option value="general">General</option>
    <option value="prescription">Prescription</option>
    <option value="report">Report</option>
    <option value="lab">Lab</option>
    <option value="surgery">Surgery</option>
  </select><br><br>

  <input id="title" placeholder="Title" /><br><br>
  <textarea id="notes" placeholder="Notes"></textarea><br><br>
</section>

<section id="repFields" style="display:none;">
  <h3>Representative Upload</h3>
  <input type="file" id="fileInput" accept="image/*,.pdf" />
</section>

<br />
<button id="saveBtn">Save</button>
<p id="status"></p>

<hr />
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db, storage } from "/js/firebase.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    addDoc,
    getDocs,
    query,
    where,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
  import { startQRScan } from "/js/qr_scan.js";

  let currentUser = null;

  requireAuth(
    ["doctor", "representative"],
    (profile) => {
      currentUser = profile;

      if (profile.role_id === "doctor") {
        document.getElementById("doctorFields").style.display = "block";
      } else {
        document.getElementById("repFields").style.display = "block";
      }
    }
  );

  document.getElementById("scanBtn").onclick = () => {
    startQRScan("qrBox", (value) => {
      document.getElementById("patientInput").value = value;
    });
  };

  document.getElementById("saveBtn").onclick = async () => {
    const statusEl = document.getElementById("status");
    statusEl.innerText = "Processing...";

    const input = document.getElementById("patientInput").value.trim();
    if (!input) {
      statusEl.innerText = "Patient ID or Mobile required";
      return;
    }

    try {
      // Find patient
      const usersRef = collection(db, "users");
      const q = isNaN(input)
        ? query(usersRef, where("phone", "==", input))
        : query(usersRef, where("health_id_10", "==", input));

      const snap = await getDocs(q);
      if (snap.empty) {
        statusEl.innerText = "Patient not found";
        return;
      }

      const patientUid = snap.docs[0].id;

      // Doctor flow
      if (currentUser.role_id === "doctor") {
        await addDoc(collection(db, "patient_records"), {
          patient_uid: patientUid,
          created_by_uid: currentUser.uid,
          created_by_role: "doctor",
          record_type: document.getElementById("recordType").value,
          title: document.getElementById("title").value || "",
          notes: document.getElementById("notes").value || "",
          visibility: "public",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        statusEl.innerText = "Record added successfully";
        return;
      }

      // Representative flow
      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        statusEl.innerText = "Please select a file";
        return;
      }

      const fileRef = ref(
        storage,
        `uploads/${patientUid}/${Date.now()}_${file.name}`
      );

      await uploadBytes(fileRef, file);
      const url = await getDownloadURL(fileRef);

      await addDoc(collection(db, "patient_records"), {
        patient_uid: patientUid,
        created_by_uid: currentUser.uid,
        created_by_role: "representative",
        record_type: "external_upload",
        title: "Uploaded document",
        notes: "",
        file_url: url,
        visibility: "public",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      statusEl.innerText = "Document uploaded successfully";

    } catch (e) {
      console.error(e);
      statusEl.innerText = "Error occurred";
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
