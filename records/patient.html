<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶°‡¶ø‡¶ï‡ßá‡¶≤ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° | DigiHealth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    /* üîπ Firebase config */
    const firebaseConfig = {
      apiKey: "AIzaSyBqUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
      authDomain: "digihealth-65f04.firebaseapp.com",
      projectId: "digihealth-65f04",
      storageBucket: "digihealth-65f04.appspot.com",
      messagingSenderId: "704628949252",
      appId: "1:704628949252:web:b38a476bd9c4259f829051"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const recordsDiv = document.getElementById("records");
    const uploadBtn = document.getElementById("uploadBtn");

    let currentUser;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "/index.html";
        return;
      }
      currentUser = user;
      loadRecords();
    });

    async function loadRecords() {
      recordsDiv.innerHTML = "‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
      const q = query(
        collection(db, "patient_records"),
        where("patient_uid", "==", currentUser.uid)
      );
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        recordsDiv.innerHTML = "‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
        return;
      }

      recordsDiv.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const r = docSnap.data();
        const div = document.createElement("div");
        div.className = "record";
        div.innerHTML = `
          <strong>${r.title || "‡¶Æ‡ßá‡¶°‡¶ø‡¶ï‡ßá‡¶≤ ‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü"}</strong><br>
          <small>${r.hidden ? "üîí ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã" : "üëÅ ‡¶¶‡ßÉ‡¶∂‡ßç‡¶Ø‡¶Æ‡¶æ‡¶®"}</small><br><br>
          <a href="${r.file_url}" target="_blank">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° / ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</a><br><br>
          <button onclick="toggleHide('${docSnap.id}', ${r.hidden})">
            ${r.hidden ? "‡¶¶‡ßá‡¶ñ‡¶æ‡¶®" : "‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®"}
          </button>
          <button class="danger" onclick="deleteRecord('${docSnap.id}', '${r.storage_path}')">
            ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®
          </button>
        `;
        recordsDiv.appendChild(div);
      });
    }

    uploadBtn.onclick = async () => {
      const fileInput = document.getElementById("file");
      const titleInput = document.getElementById("title");

      if (!fileInput.files.length) {
        alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");
        return;
      }

      const file = fileInput.files[0];
      const storagePath = `records/${currentUser.uid}/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, storagePath);

      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);

      await addDoc(collection(db, "patient_records"), {
        patient_uid: currentUser.uid,
        title: titleInput.value || "‡¶Æ‡ßá‡¶°‡¶ø‡¶ï‡ßá‡¶≤ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü",
        file_url: url,
        storage_path: storagePath,
        hidden: false,
        createdAt: serverTimestamp()
      });

      titleInput.value = "";
      fileInput.value = "";
      loadRecords();
    };

    window.toggleHide = async (id, hidden) => {
      await updateDoc(doc(db, "patient_records", id), { hidden: !hidden });
      loadRecords();
    };

    window.deleteRecord = async (id, path) => {
      if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶è‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§")) return;
      await deleteObject(ref(storage, path));
      await deleteDoc(doc(db, "patient_records", id));
      loadRecords();
    };
  </script>

  <style>
    body { font-family: system-ui; padding: 15px; }
    .record {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    button {
      padding: 6px 10px;
      margin-right: 5px;
    }
    .danger {
      background: #d32f2f;
      color: white;
      border: none;
    }
  </style>
</head>

<body>
  <h2>‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶°‡¶ø‡¶ï‡ßá‡¶≤ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</h2>

  <input id="title" placeholder="‡¶°‡¶ï‡ßÅ‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)" /><br><br>
  <input type="file" id="file" accept=".pdf,image/*" /><br><br>
  <button id="uploadBtn">‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>

  <hr>
  <div id="records"></div>
</body>
</html>
