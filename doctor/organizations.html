<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <title>Create Organization â€” DigiHealth</title>
</head>
<body>

<h2>Create Organization</h2>

<p id="status"></p>

<form id="orgForm">
  <label>Organization Name</label><br>
  <input id="name" required><br><br>

  <label>Registration Number (TIN / Company No)</label><br>
  <input id="regNo" required><br><br>

  <label>Contact Phone</label><br>
  <input id="phone"><br><br>

  <label>Address</label><br>
  <textarea id="address"></textarea><br><br>

  <label>Organization License (Image / PDF)</label><br>
  <input type="file" id="licenseFile" accept="image/*,.pdf" required><br><br>

  <button type="button" id="createBtn">Submit for Approval</button>
</form>

<hr>
<button id="logoutBtn">Logout</button>

<script type="module">
  import { requireAuth } from "/js/auth_guard.js";
  import { auth, db, storage } from "/js/firebase.js";
  import { signOut } from
    "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import {
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  let currentUser = null;

  // ðŸ” Any logged-in user can apply to create organization
  requireAuth(
    ["patient", "doctor", "clinic_manager", "assistant_manager"],
    (profile) => {
      currentUser = profile;
    }
  );

  document.getElementById("createBtn").onclick = async () => {
    const statusEl = document.getElementById("status");
    statusEl.innerText = "Uploading license...";

    const name = document.getElementById("name").value.trim();
    const regNo = document.getElementById("regNo").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const address = document.getElementById("address").value.trim();
    const file = document.getElementById("licenseFile").files[0];

    if (!name || !regNo || !file) {
      statusEl.innerText = "Name, registration number and license required";
      return;
    }

    try {
      /* 1ï¸âƒ£ Upload license to Firebase Storage */
      const storageRef = ref(
        storage,
        `organization_licenses/${Date.now()}_${file.name}`
      );

      await uploadBytes(storageRef, file);
      const licenseURL = await getDownloadURL(storageRef);

      /* 2ï¸âƒ£ Create organization (PENDING) */
      await addDoc(collection(db, "organizations"), {
        name,
        registration_no: regNo,
        contact_phone: phone,
        address,
        license_image_url: licenseURL,

        status: "pending",
        owner_uid: currentUser.uid,

        createdAt: serverTimestamp()
      });

      statusEl.innerText =
        "Organization submitted. Waiting for admin approval.";

      document.getElementById("orgForm").reset();

    } catch (e) {
      console.error(e);
      statusEl.innerText = "Error occurred. Try again.";
    }
  };

  document.getElementById("logoutBtn").onclick = async () => {
    await signOut(auth);
    location.href = "/index.html";
  };
</script>

</body>
</html>
