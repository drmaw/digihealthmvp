<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>ডাক্তারের অ্যাপয়েন্টমেন্ট</title>
</head>
<body>

<h3>আমার অ্যাপয়েন্টমেন্টসমূহ</h3>

<button id="todayBtn">আজকের</button>
<button id="upcomingBtn">আসন্ন</button>
<button id="pastBtn">সম্পন্ন</button>

<hr>

<div id="list"></div>

<pre id="msg"></pre>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* ---------- Firebase config ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBQUDMQgc57d4wWSW2auFyYCS19q8vxBU4",
    authDomain: "digihealth-65f04.firebaseapp.com",
    projectId: "digihealth-65f04",
    storageBucket: "digihealth-65f04.appspot.com",
    messagingSenderId: "704628949252",
    appId: "1:704628949252:web:b38a476bd9c4259f829051"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const list = document.getElementById("list");
  const msg = document.getElementById("msg");

  const todayBtn = document.getElementById("todayBtn");
  const upcomingBtn = document.getElementById("upcomingBtn");
  const pastBtn = document.getElementById("pastBtn");

  let currentDoctorUid = null;

  /* ---------- Helpers ---------- */

  function todayStr() {
    return new Date().toISOString().split("T")[0];
  }

  async function loadAppointments(filter) {
    list.innerHTML = "";
    msg.textContent = "লোড হচ্ছে...";

    const ref = collection(db, "appointments");
    let q = query(ref, where("doctor_uid", "==", currentDoctorUid));

    const snap = await getDocs(q);

    if (snap.empty) {
      msg.textContent = "কোন অ্যাপয়েন্টমেন্ট নেই";
      return;
    }

    msg.textContent = "";

    snap.docs.forEach(d => {
      const a = d.data();

      if (filter === "today" && a.appointment_date !== todayStr()) return;
      if (filter === "upcoming" && a.appointment_date < todayStr()) return;
      if (filter === "past" && a.status !== "completed") return;

      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.padding = "10px";
      div.style.marginBottom = "10px";

      div.innerHTML = `
        <b>তারিখ:</b> ${a.appointment_date} <br>
        <b>সময়:</b> ${a.appointment_time} <br>
        <b>স্ট্যাটাস:</b> ${a.status} <br><br>
      `;

      /* ---------- Action buttons ---------- */
      if (a.status === "requested") {
        const acceptBtn = document.createElement("button");
        acceptBtn.textContent = "গ্রহণ করুন";
        acceptBtn.onclick = () =>
          updateStatus(d.id, "accepted");

        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "বাতিল করুন";
        rejectBtn.onclick = () =>
          updateStatus(d.id, "rejected");

        div.appendChild(acceptBtn);
        div.appendChild(rejectBtn);
      }

      if (a.status === "accepted") {
        const completeBtn = document.createElement("button");
        completeBtn.textContent = "সম্পন্ন";
        completeBtn.onclick = () =>
          updateStatus(d.id, "completed");

        div.appendChild(completeBtn);
      }

      list.appendChild(div);
    });
  }

  async function updateStatus(id, status) {
    await updateDoc(doc(db, "appointments", id), {
      status: status
    });
    loadAppointments("today");
  }

  /* ---------- Auth ---------- */
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      msg.textContent = "লগইন করা নেই";
      return;
    }

    currentDoctorUid = user.uid;
    loadAppointments("today");
  });

  todayBtn.onclick = () => loadAppointments("today");
  upcomingBtn.onclick = () => loadAppointments("upcoming");
  pastBtn.onclick = () => loadAppointments("past");

</script>

</body>
</html>
