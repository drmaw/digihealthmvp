<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>QR Scan ‚Äî DigiHealth</title>
</head>

<body>

<h3>üì∑ QR Scan</h3>
<p id="msg">Processing QR...</p>

<script type="module">
  import { parseQRPayload } from "/js/qr.js";
  import { searchUser } from "/js/search.js";

  const msg = document.getElementById("msg");

  const params = new URLSearchParams(window.location.search);
  const data = params.get("data");
  const returnTo = params.get("return") || "/clinic/search.html";

  if (!data) {
    msg.innerText = "‚ùå QR data missing";
    throw new Error("No QR data");
  }

  const payload = parseQRPayload(data);

  if (!payload || !payload.digihealth_id) {
    msg.innerText = "‚ùå Invalid QR code";
    throw new Error("Invalid QR");
  }

  const user = await searchUser(payload.digihealth_id);

  if (!user) {
    msg.innerText = "‚ùå Patient not found";
    throw new Error("User not found");
  }

  // Redirect to profile
  location.href = `/profile/view.html?uid=${user.uid}`;
</script>

</body>
</html>
